<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Kiosk - Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {background:#f5f7fb}
    .sidebar {height:100vh; position:fixed; width:260px;}
    .content {margin-left:280px; padding:24px}
    .kiosk-preview {background:#fff; border:1px solid #e3e6ef; border-radius:8px; padding:16px}
    .ticket {font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding:12px; border:1px dashed #ccd; background:#fafafa; border-radius:6px}
  </style>
</head>
<body>
  <div class="d-flex">
    <nav class="sidebar bg-white border-end p-3">
      <h5 class="mb-4">Kiosk Admin</h5>
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link active" href="#dashboard">Tổng quan</a></li>
        <li class="nav-item"><a class="nav-link" href="#queues">Quản lý số</a></li>
        <li class="nav-item"><a class="nav-link" href="#kiosks">Quản lý Kiosk</a></li>
        <li class="nav-item"><a class="nav-link" href="#templates">Giao diện</a></li>
        <li class="nav-item"><a class="nav-link" href="#users">Người dùng</a></li>
        <li class="nav-item"><a class="nav-link" href="#logs">Nhật ký</a></li>
        <li class="nav-item mt-3"><button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addQueueModal">Thêm chức năng mới</button></li>
      </ul>
      <div class="mt-4 text-muted small">Phiên bản: 1.0.0</div>
    </nav>

    <main class="content flex-grow-1">
      <!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>KPI Report - Kiosk</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body{background:#f7fafc;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    .card{border-radius:12px}
    .kpi-number{font-size:1.6rem;font-weight:700}
    .muted{color:#6b7280}
    .small{font-size:0.85rem}
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>KPI Báo cáo - Tổng quan</h4>
      <div>
        <input type="date" id="date" class="form-control form-control-sm d-inline-block" style="width:180px">
        <button id="refresh" class="btn btn-sm btn-primary ms-2">Làm mới</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-md-3">
        <div class="card p-3">
          <div class="muted small">Số lượt phục vụ (tổng/ngày)</div>
          <div id="kpi-served" class="kpi-number">0</div>
          <div class="muted small">(Theo dịch vụ/ca có bảng chi tiết bên dưới)</div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card p-3">
          <div class="muted small">Thời gian chờ trung bình</div>
          <div id="kpi-avg-wait" class="kpi-number">00:00</div>
          <div class="muted small">(avg wait time)</div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card p-3">
          <div class="muted small">Thời gian phục vụ trung bình</div>
          <div id="kpi-avg-service" class="kpi-number">00:00</div>
          <div class="muted small">(avg service time)</div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card p-3">
          <div class="muted small">Tỷ lệ no-show</div>
          <div id="kpi-noshow" class="kpi-number">0%</div>
          <div class="muted small">(Đặt hẹn nhưng không check-in)</div>
        </div>
      </div>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-3">
        <div class="card p-3">
          <div class="muted small">Số lượng ưu tiên xử lý</div>
          <div id="kpi-priority" class="kpi-number">0</div>
          <div class="muted small">(Tickets marked priority)</div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card p-3">
          <div class="muted small">Tỷ lệ bỏ hẹn / hủy hẹn</div>
          <div id="kpi-cancel-rate" class="kpi-number">0%</div>
          <div class="muted small">(Canceled / Booked)</div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div><strong>Phân tích theo dịch vụ / ca</strong><div class="small muted">Số lượt & thời gian trung bình</div></div>
            <div>
              <select id="shiftSelect" class="form-select form-select-sm">
                <option value="all">-- Tất cả ca --</option>
                <option value="morning">Sáng</option>
                <option value="afternoon">Chiều</option>
                <option value="evening">Tối</option>
              </select>
            </div>
          </div>
          <div class="mt-3" style="max-height:260px;overflow:auto">
            <table class="table table-sm">
              <thead><tr><th>Service</th><th>Lượt phục vụ</th><th>Avg Wait</th><th>Avg Service</th><th>No-show%</th><th>Priority</th><th>Cancel%</th></tr></thead>
              <tbody id="serviceSummary"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-12">
        <div class="card p-3">
          <h6>Biểu đồ: Số lượt phục vụ theo dịch vụ</h6>
          <div style="height:240px"><canvas id="servedChart"></canvas></div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Demo data generation
    const services = [ {id:'S1',name:'Nộp hồ sơ'}, {id:'S2',name:'Cấp giấy'}, {id:'S3',name:'Tư vấn'} ];
    const shifts = {
      morning: {start:8,end:12},
      afternoon: {start:12,end:17},
      evening: {start:17,end:21}
    };

    const tickets = [];
    (function gen(){
      const today = new Date();
      for(let i=1;i<=300;i++){
        const svc = services[Math.floor(Math.random()*services.length)];
        const hour = 8 + Math.floor(Math.random()*13); // 8..20
        const min = Math.floor(Math.random()*60);
        const issued = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hour, min, Math.floor(Math.random()*60));
        const booked = Math.random()<0.6; // 60% booked
        const checkin = booked ? (Math.random()<0.85) : (Math.random()<0.2); // if booked, 85% check-in
        const canceled = !checkin && booked && Math.random()<0.5; // half of not-checkin booked are cancel
        const priority = Math.random()<0.08; // 8% priority
        let start=null,end=null,served=false;
        if(checkin && !canceled){
          const wait = (Math.floor(Math.random()*20)+1)*60*1000; // 1-20 min
          start = new Date(issued.getTime()+wait);
          const servDur = (Math.floor(Math.random()*15)+1)*60*1000; //1-15 min
          end = new Date(start.getTime()+servDur);
          served = true;
        }
        const staffId = served? Math.ceil(Math.random()*8) : null;
        tickets.push({id:'T'+String(i).padStart(4,'0'),service:svc.id,issued:issued.toISOString(),booked,checkin,canceled,priority,start:start?start.toISOString():null,end:end?end.toISOString():null,staffId});
      }
    })();

    // helpers
    function secs(a,b){ if(!a||!b) return null; return Math.round((new Date(b)-new Date(a))/1000); }
    function fmtSecToMMSS(s){ if(s===null) return '-'; const m=Math.floor(s/60); const sec=s%60; return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; }

    // compute KPIs
    function computeKPIs(filterShift='all'){
      const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
      let data = tickets.filter(t=>t.issued.slice(0,10)===date);
      if(filterShift!=='all'){ const sh = shifts[filterShift]; data = data.filter(t=>{ const h = new Date(t.issued).getHours(); return h>=sh.start && h<sh.end; }); }

      // overall
      const servedCount = data.filter(t=>t.end).length;
      const avgWait = (()=>{ const waits = data.map(t=>secs(t.issued,t.start)).filter(x=>x!==null); return waits.length?Math.round(waits.reduce((a,b)=>a+b,0)/waits.length):0; })();
      const avgService = (()=>{ const s = data.map(t=>secs(t.start,t.end)).filter(x=>x!==null); return s.length?Math.round(s.reduce((a,b)=>a+b,0)/s.length):0; })();
      const booked = data.filter(t=>t.booked).length;
      const noShow = booked? data.filter(t=>t.booked && !t.checkin).length : 0;
      const noshowRate = booked? Math.round(noShow/booked*10000)/100 : 0;
      const priorityCount = data.filter(t=>t.priority).length;
      const cancelRate = data.filter(t=>t.canceled).length ? Math.round(data.filter(t=>t.canceled).length/data.filter(t=>t.booked).length*10000)/100 : 0;

      document.getElementById('kpi-served').innerText = servedCount;
      document.getElementById('kpi-avg-wait').innerText = fmtSecToMMSS(avgWait);
      document.getElementById('kpi-avg-service').innerText = fmtSecToMMSS(avgService);
      document.getElementById('kpi-noshow').innerText = noshowRate + '%';
      document.getElementById('kpi-priority').innerText = priorityCount;
      document.getElementById('kpi-cancel-rate').innerText = isNaN(cancelRate)?'0%':cancelRate + '%';

      // per-service summary
      const tbody = document.getElementById('serviceSummary'); tbody.innerHTML='';
      const chartLabels=[], chartData=[];
      services.forEach(svc=>{
        const arr = data.filter(t=>t.service===svc.id);
        const served = arr.filter(t=>t.end).length;
        const waits = arr.map(t=>secs(t.issued,t.start)).filter(x=>x!==null);
        const avgW = waits.length?Math.round(waits.reduce((a,b)=>a+b,0)/waits.length):0;
        const servs = arr.map(t=>secs(t.start,t.end)).filter(x=>x!==null);
        const avgS = servs.length?Math.round(servs.reduce((a,b)=>a+b,0)/servs.length):0;
        const bookedSvc = arr.filter(t=>t.booked).length;
        const noshowSvc = bookedSvc? arr.filter(t=>t.booked && !t.checkin).length : 0;
        const noshowPct = bookedSvc? Math.round(noshowSvc/bookedSvc*10000)/100 : 0;
        const priority = arr.filter(t=>t.priority).length;
        const cancelPct = bookedSvc? Math.round(arr.filter(t=>t.canceled).length/bookedSvc*10000)/100 : 0;
        const tr = document.createElement('tr'); tr.innerHTML = `<td>${svc.name}</td><td>${served}</td><td>${fmtSecToMMSS(avgW)}</td><td>${fmtSecToMMSS(avgS)}</td><td>${noshowPct}%</td><td>${priority}</td><td>${cancelPct}%</td>`; tbody.appendChild(tr);

        chartLabels.push(svc.name); chartData.push(served);
      });

      updateChart(chartLabels,chartData);
    }

    // chart
    let servedChart;
    function createChart(){ const ctx = document.getElementById('servedChart').getContext('2d'); servedChart = new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'Lượt phục vụ',data:[],backgroundColor:'rgba(54,162,235,0.6)'}]},options:{responsive:true,plugins:{legend:{display:false}}}}); }
    function updateChart(labels,data){ servedChart.data.labels = labels; servedChart.data.datasets[0].data = data; servedChart.update(); }

    // init
    document.getElementById('date').value = new Date().toISOString().slice(0,10);
    document.getElementById('refresh').addEventListener('click', ()=> computeKPIs(document.getElementById('shiftSelect').value));
    document.getElementById('shiftSelect').addEventListener('change', ()=> computeKPIs(document.getElementById('shiftSelect').value));

    createChart(); computeKPIs('all');
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


    </main>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="addQueueModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Thêm chức năng / quầy</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-2"><label class="form-label">Tên chức năng</label><input id="newQueueName" class="form-control"></div>
          <div class="mb-2"><label class="form-label">Mã</label><input id="newQueueCode" class="form-control"></div>
          <div class="mb-2"><label class="form-label">Ưu tiên (số)</label><input id="newQueuePriority" type="number" class="form-control" value="1"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button class="btn btn-primary" id="createQueue">Tạo</button></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addKioskModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Thêm Kiosk</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-2"><label class="form-label">Tên</label><input id="kioskName" class="form-control"></div>
          <div class="mb-2"><label class="form-label">IP / Host</label><input id="kioskHost" class="form-control"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button class="btn btn-primary" id="createKiosk">Tạo</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Demo in-memory store
    const store = { queues: [], kiosks: [], users: [{id:1,name:'admin'}], served:0, logs:[] };
    let nextId = 1;

    // Helpers
    function renderQueues() {
      const tbody = document.querySelector('#queuesTable tbody'); tbody.innerHTML='';
      store.queues.forEach(q => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${q.id}</td><td>${q.name}</td><td>${q.code}</td><td>${q.priority}</td><td><button class="btn btn-sm btn-outline-primary" onclick="selectQueue(${q.id})">Xem</button> <button class="btn btn-sm btn-danger" onclick="deleteQueue(${q.id})">Xóa</button></td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('waitingCount').innerText = store.queues.length;
    }

    function renderKiosks(){
      const tbody = document.querySelector('#kioskTable tbody'); tbody.innerHTML='';
      store.kiosks.forEach(k=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${k.id}</td><td>${k.name}</td><td>${k.host}</td><td>${k.online? 'Online' : 'Offline'}</td><td><button class="btn btn-sm btn-outline-secondary" onclick="pingKiosk(${k.id})">Ping</button> <button class="btn btn-sm btn-danger" onclick="removeKiosk(${k.id})">Xóa</button></td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('onlineKiosks').innerText = store.kiosks.filter(k=>k.online).length;
    }

    function renderUsers(){
      const ul = document.getElementById('usersList'); ul.innerHTML='';
      store.users.forEach(u=>{ const li = document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center'; li.innerHTML = `<div>${u.name} <small class="text-muted">(id:${u.id})</small></div><div><button class="btn btn-sm btn-outline-danger" onclick="removeUser(${u.id})">Xóa</button></div>`; ul.appendChild(li); });
    }

    function log(msg){ store.logs.push({t:new Date().toISOString(),m:msg}); const box = document.getElementById('logBox'); box.innerText = store.logs.map(l=>`[${l.t}] ${l.m}`).reverse().join('\n'); }

    // Actions
    document.getElementById('createQueue').addEventListener('click', ()=>{
      const name = document.getElementById('newQueueName').value.trim();
      const code = document.getElementById('newQueueCode').value.trim();
      const pr = parseInt(document.getElementById('newQueuePriority').value)||1;
      if(!name||!code){alert('Nhập tên và mã');return}
      const q = {id: nextId++, name, code, priority:pr}; store.queues.push(q); renderQueues(); log(`Tạo chức năng ${name}`);
      const modal = bootstrap.Modal.getInstance(document.getElementById('addQueueModal')); modal.hide();
    });

    window.deleteQueue = function(id){ store.queues = store.queues.filter(q=>q.id!==id); renderQueues(); log(`Xóa chức năng id=${id}`); }
    window.selectQueue = function(id){ const q = store.queues.find(x=>x.id===id); if(!q) return; document.getElementById('previewTitle').innerText = q.name; document.getElementById('previewDesc').innerText = `Mã: ${q.code} — Ưu tiên: ${q.priority}`; document.getElementById('ticketSample').innerText = `SỐ: ${String(q.code).toUpperCase()}-${Math.floor(Math.random()*900+100)}\nThời gian: ${new Date().toLocaleString()}`; }

    // Kiosk
    document.getElementById('addKioskBtn').addEventListener('click', ()=>{ new bootstrap.Modal(document.getElementById('addKioskModal')).show(); });
    document.getElementById('createKiosk').addEventListener('click', ()=>{
      const name = document.getElementById('kioskName').value.trim(); const host = document.getElementById('kioskHost').value.trim(); if(!name||!host){alert('Nhập tên và host');return}
      const k = {id: nextId++, name, host, online: Math.random()>0.3}; store.kiosks.push(k); renderKiosks(); log(`Thêm kiosk ${name} (${host})`);
      const modal = bootstrap.Modal.getInstance(document.getElementById('addKioskModal')); modal.hide();
    });
    window.pingKiosk = function(id){ const k = store.kiosks.find(x=>x.id===id); if(!k) return; k.online = !k.online; renderKiosks(); log(`Ping kiosk ${k.name}: ${k.online? 'online':'offline'}`); }
    window.removeKiosk = function(id){ store.kiosks = store.kiosks.filter(k=>k.id!==id); renderKiosks(); log(`Xóa kiosk id=${id}`); }

    // Users
    document.getElementById('addUserBtn').addEventListener('click', ()=>{ const name = prompt('Tên người dùng'); if(!name) return; const u={id:nextId++,name}; store.users.push(u); renderUsers(); log(`Tạo user ${name}`); });
    window.removeUser = function(id){ store.users = store.users.filter(u=>u.id!==id); renderUsers(); log(`Xóa user id=${id}`); }

    // Settings
    document.getElementById('saveSettings').addEventListener('click', ()=>{ const t=document.getElementById('timeoutSec').value; localStorage.setItem('kiosk_timeout', t); alert('Lưu cấu hình thành công'); log(`Lưu timeout = ${t}s`); });

    // Import / Export
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const data = JSON.stringify(store, null, 2); const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='kiosk_admin_export.json'; a.click(); URL.revokeObjectURL(url); log('Export JSON');
    });
    document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{ try{ const obj = JSON.parse(reader.result); if(obj.queues) { store.queues = obj.queues; store.kiosks = obj.kiosks||[]; store.users = obj.users||store.users; renderQueues(); renderKiosks(); renderUsers(); log('Import JSON thành công'); alert('Import thành công'); } else { alert('File không hợp lệ'); } }catch(err){ alert('Đọc file thất bại'); }}; reader.readAsText(f);
    });

    // Print sample
    document.getElementById('printSample').addEventListener('click', ()=>{
      const w = window.open('','_blank','width=320,height=480'); w.document.write(`<pre style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">${document.getElementById('ticketSample').innerText}</pre>`); w.print(); w.close(); log('In vé mẫu');
    });

    // Init demo data
    (function init(){ store.queues = [ {id:nextId++, name:'Nộp hồ sơ', code:'NH', priority:1}, {id:nextId++, name:'Bốc số', code:'BS', priority:2}, {id:nextId++, name:'Hướng dẫn', code:'HD', priority:3} ]; store.kiosks = [{id:nextId++,name:'Kiosk A',host:'192.168.1.10',online:true},{id:nextId++,name:'Kiosk B',host:'192.168.1.11',online:false}]; renderQueues(); renderKiosks(); renderUsers(); log('Hệ thống khởi tạo'); })();
  </script>
</body>
</html>
